# MineAnvil Work Ticket — SP2.3 Validation (B2: Resume From Staging, No Re-Download)

Before proposing or changing any code, you MUST obey the following hierarchy, in this exact order of authority:
1. /.context/00-guardrails.md (absolute law)
2. /docs/STOP_POINTS.md (scoreboard of progress)
3. /.context/02-execution-map.md (layer sequencing)
4. /.context/05-development-plan.md (how work proceeds)
5. /.context/03-what-needs-built.md (system responsibilities)
6. /.context/01-exec-summary.md (strategic intent)
7. /.context/04-project-summary.md (narrative context)

If any instruction conflicts with 00-guardrails.md, guardrails win.

IMPORTANT: Read and follow the canonical boot prompt at:
- /.context/boot_prompt.md

DO NOT browse the web. Do not invent requirements. Do not modify STOP_POINTS.md items marked [done].
This ticket is VALIDATION SUPPORT + EVIDENCE CAPTURE for SP2.3 only.

---

## Objective
Provide a deterministic, operator-friendly way to execute SP2.3 “Scenario B2: Resume from staging without re-download” and capture evidence (logs + filesystem) proving the resume path occurred.

---

## Layer
2

---

## Stop Point
2.3 — Rollback & Recovery

---

## Acceptance Criteria
- [ ] Operator can run a single script that orchestrates B2 in two phases: (1) create valid staging artifact and kill before promote, (2) re-run and confirm resume-from-staging occurred without downloading.
- [ ] Evidence pack is generated under repo (e.g. `evidence/sp2.3-b2/`) containing:
  - staging listing BEFORE resume
  - staging listing AFTER resume
  - final location existence check
  - recovery-related log excerpts proving “resume/promote/cleanup” and proving “no re-download”
  - manifest + lockfile immutability checks
- [ ] A short validation summary markdown is produced and ready to paste into `docs/SP2.3-rollback-recovery.md` (or a dedicated validation report file), without changing STOP_POINTS.md checkboxes.

---

## Non-Goals
- Do NOT change core installer logic unless absolutely required to capture evidence.
- Do NOT mark STOP_POINTS.md items as [done].
- Do NOT add UI or Layer 3 work.

---

## Files Expected to Change
- scripts/validation/sp2.3-b2-run.ps1 (new)  # orchestrator script (read-only + process control)
- scripts/validation/sp2.3-b2-assert.ps1 (new) # assertions + evidence capture
- scripts/validation/parse-recovery-logs.ps1 (update if needed, but keep it read-only)
- docs/validation/SP2.3-b2-resume-from-staging.md (new) # validation report template + filled outputs section
- (optional) README in scripts/validation/ explaining how to run B2

No surprises allowed. If you think more files are needed, list them BEFORE changing anything.

---

## Implementation Notes
Constraints:
- Must work on Windows PowerShell (pwsh) in the repo root.
- Must not depend on any GUI automation.
- Must not fabricate staging artifacts.
- Must kill MineAnvil at the correct moment: AFTER a fully-downloaded staging artifact exists, BEFORE atomic promotion completes.

Approach:
- Use the client jar artifact as the trigger:
  `%APPDATA%\MineAnvil\instances\default\.minecraft\versions\1.21.4\1.21.4.jar`
- The script should:
  1) Ensure MineAnvil is not running.
  2) Delete the final client jar (to force installer to act).
  3) Start MineAnvil (via `cmd.exe /c npm run dev:electron` so npm is found).
  4) Tail `%APPDATA%\MineAnvil\instances\default\logs\mineanvil-main.log` and detect “download complete to staging” signals.
  5) Immediately kill the electron process once staging file exists and is FULL SIZE (approx 27MB) and BEFORE promotion.
  6) Capture staging listing + file size + confirm final file missing.
  7) Prompt operator to re-run MineAnvil normally.
  8) After re-run, parse logs to confirm:
     - “checking staging area for recoverable artifacts”
     - “resuming artifact from staging”
     - “promoting artifacts from staging”
     - “staging directory cleaned up”
     - AND confirm absence of “downloading artifact to staging” for that artifact on the resume run.
  9) Confirm final client jar exists.
  10) Run immutability checks for manifest and lockfile and include in evidence.

Log matching:
- You must implement robust string filters, not brittle exact-match only.
- Include a `-vvv` / `--verbose` option in scripts to print what they are matching and the last N relevant log lines.

Process kill:
- Must reliably terminate MineAnvil (electron.exe) when trigger hits.
- Avoid killing too early (partial download) and too late (promotion complete).

Evidence output:
- Write evidence to `evidence/sp2.3-b2/<timestamp>/...`
- Include a single `validation-summary.md` generated by script.

---

## Test Plan
Operator-run on Windows:
1) Run `pwsh -ExecutionPolicy Bypass -File scripts/validation/sp2.3-b2-run.ps1 -InstanceId default -McVersion 1.21.4 -Verbose -vvv`
2) Script performs Phase 1: deletes final jar, launches MineAnvil, waits for full staging jar, kills MineAnvil, captures evidence.
3) Operator runs MineAnvil again: `npm run dev:electron`
4) Run `pwsh -ExecutionPolicy Bypass -File scripts/validation/sp2.3-b2-assert.ps1 -InstanceId default -McVersion 1.21.4 -Verbose -vvv`
5) Confirm PASS/FAIL and evidence artifacts created.

Failure cases to handle:
- If staging is partial: script should detect size < expected, mark “B2 not ready”, advise rerun.
- If promotion already happened: final jar exists, staging absent: script should mark “killed too late”, advise rerun.
- If logs rotated: script should search rotated logs or widen lookback window.

---

## Stop Point Update
No STOP_POINTS.md updates in this ticket. This ticket produces evidence only.
A follow-up ticket will mark relevant SP2.3 checklist items [done] after evidence review.

---

## Deliverables (what you must output)
1) The new/updated PowerShell scripts.
2) `docs/validation/SP2.3-b2-resume-from-staging.md` containing:
   - how to run B2
   - what PASS looks like
   - placeholders for evidence
3) A short “Operator Steps” section at the top of that doc that I can follow verbatim.

Remember:
- If any instruction conflicts with 00-guardrails.md, guardrails win.
- Include verbose/debug options in scripts.
- Never log secrets or tokens.
