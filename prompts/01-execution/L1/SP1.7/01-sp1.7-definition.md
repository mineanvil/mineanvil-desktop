# Stop Point 1.7 — Multi Java Runtime (17 + 21)

## Purpose

Extend MineAnvil portable builds to support launching both modern and legacy Minecraft versions by bundling both Java 17 and Java 21 JREs. The application automatically selects the correct Java runtime based on the Minecraft version being launched, ensuring compatibility without requiring manual configuration.

## Scope

### In Scope
- Bundling both Eclipse Temurin JRE 17 and 21 in portable builds
- Version-aware runtime selection based on Minecraft version
- Deterministic path resolution with no runtime globbing
- Offline operation with bundled runtimes
- Dev-only environment variable overrides for testing
- Parent-friendly error messages specifying required Java version

### Out of Scope
- Java installation or download at runtime (all fetching is build-time only)
- Automatic Java version detection from installed system Java
- Supporting non-Windows platforms (Windows x64 only)
- Bundling more than two Java major versions
- Dynamic Java version requirement detection (uses fixed threshold)

## Mandatory Layout

### Dev Build Layout
```
electron/vendor/java/win32-x64/jre17/runtime/bin/java.exe
electron/vendor/java/win32-x64/jre21/runtime/bin/java.exe
```

### Packaged Build Layout
```
resources/java/win32-x64/jre17/runtime/bin/java.exe
resources/java/win32-x64/jre21/runtime/bin/java.exe
```

### Key Constraints
- Paths are deterministic and exact (no glob patterns)
- Directory names are normalized: `jre17` and `jre21` (not version-specific)
- All runtimes contain `runtime/bin/java.exe` at consistent depth
- No nested or variable directory structures

## Selection Rule

### Version Threshold
- **Minecraft >= 1.20.5**: Requires Java 21
- **Minecraft < 1.20.5**: Requires Java 17

### Version Comparison
- Parse Minecraft version as semantic version (major.minor.patch)
- Compare numerically (not lexicographically)
- Example: `1.21.11` >= `1.20.5` → Java 21
- Example: `1.20.4` < `1.20.5` → Java 17

### Resolution Order (Per Major Version)
1. **Bundled runtime** (always preferred in packaged builds)
   - Packaged: `process.resourcesPath/java/win32-x64/jre{major}/runtime/bin/java.exe`
   - Dev: `electron/vendor/java/win32-x64/jre{major}/runtime/bin/java.exe`
2. **MINEANVIL_JAVA_PATH** (dev only, validated for correct major version)
3. **PATH** (dev only, requires `MINEANVIL_ALLOW_PATH_JAVA=1`)

## Implementation

### Core Functions

#### `getRequiredJavaMajorForMinecraftVersion(version: string): 17 | 21`
Determines required Java major version based on Minecraft version threshold.

**Location**: `electron/src/main/runtime/javaSelection.ts:52`

**Logic**:
```typescript
const threshold = "1.20.5";
return compareVersions(minecraftVersion, threshold) >= 0 ? 21 : 17;
```

#### `resolveJavaForMinecraftVersion(version: string): JavaResolutionResult`
Resolves Java runtime for a given Minecraft version using resolution order.

**Location**: `electron/src/main/runtime/javaSelection.ts:201`

**Return Type**:
```typescript
interface JavaResolutionResult {
  readonly source: "bundled" | "env" | "path" | "none";
  readonly javaPath: string | null;
  readonly major: 17 | 21;
}
```

**Resolution Steps**:
1. Determine required major version
2. Check bundled runtime first
3. If not found, check MINEANVIL_JAVA_PATH (with version validation)
4. If not found, check PATH (if opted-in, with version validation)
5. Return result with source and path

### Launch Integration

**Location**: `electron/src/main/minecraft/launch.ts:57-64`

```typescript
// SP1.7: Resolve Java based on Minecraft version
const javaResolution = await resolveJavaForMinecraftVersion(versionId);
if (!javaResolution.javaPath) {
  throw new Error(
    `No Java ${javaResolution.major} runtime available for Minecraft ${versionId}. ` +
      `Reinstall MineAnvil or set MINEANVIL_JAVA_PATH to a Java ${javaResolution.major} installation.`,
  );
}
const javaPath = javaResolution.javaPath;
```

### Build-Time Fetching

**Location**: `scripts/fetch-java-runtime.ts`

**Runtime Configurations**:
```typescript
const RUNTIME_CONFIGS: RuntimeConfig[] = [
  {
    major: 17,
    vendor: "Eclipse Temurin",
    version: "17.0.13+11",
    platform: "win32-x64",
    downloadUrl: "https://github.com/adoptium/temurin17-binaries/releases/...",
    sha256: "11a61a94d383e755b08b4e5890a13d148bc9f95b7149cbbeec62efb8c75a4a67",
  },
  {
    major: 21,
    vendor: "Eclipse Temurin",
    version: "21.0.5+11",
    platform: "win32-x64",
    downloadUrl: "https://github.com/adoptium/temurin21-binaries/releases/...",
    sha256: "1749b36cfac273cee11802bf3e90caada5062de6a3fef1a3814c0568b25fd654",
  },
];
```

**Fetch Process**:
1. Check if runtime already exists (skip if present)
2. Download ZIP from official Adoptium releases
3. Verify SHA256 checksum (fail fast on mismatch)
4. Extract to temporary directory using PowerShell Expand-Archive
5. Normalize directory structure (rename nested dir to `runtime/`)
6. Verify `java.exe` exists at expected path
7. Move to final location
8. Clean up temporary files

### Packaging Configuration

**Location**: `package.json:63-73`

```json
"extraResources": [
  {
    "from": "electron/vendor/java/win32-x64/jre17/runtime",
    "to": "java/win32-x64/jre17/runtime",
    "filter": ["**/*"]
  },
  {
    "from": "electron/vendor/java/win32-x64/jre21/runtime",
    "to": "java/win32-x64/jre21/runtime",
    "filter": ["**/*"]
  }
]
```

**Prebuild Hooks**:
```json
"prebuild:electron": "npm run generate:ms-client-id && npm run fetch:java-runtime"
```

## Build-Time Verification

### Step 1: Fetch Runtimes
```bash
npm run fetch:java-runtime
```

**Expected Output**:
```
[fetch-java-runtime] Fetching 2 runtimes (Java 17, 21)
[fetch-java-runtime] Fetching Java 17 runtime
[fetch-java-runtime] Downloading: https://github.com/adoptium/...
[fetch-java-runtime]   Downloaded: 100.0%
[fetch-java-runtime] Computed SHA256: 11a61a94d383e755b08b4e5890a13d148bc9f95b7149cbbeec62efb8c75a4a67
[fetch-java-runtime] Expected SHA256: 11a61a94d383e755b08b4e5890a13d148bc9f95b7149cbbeec62efb8c75a4a67
[fetch-java-runtime] ✅ Checksum verified
[fetch-java-runtime] Extracting: ...
[fetch-java-runtime] ✅ Extraction complete
[fetch-java-runtime] ✅ Normalized to: .../jre17/runtime
[fetch-java-runtime] ✅ Verified: .../jre17/runtime/bin/java.exe
[fetch-java-runtime] ✅ Java 17 runtime successfully fetched and installed
[fetch-java-runtime] Fetching Java 21 runtime
... (similar output for Java 21)
[fetch-java-runtime] ✅ All Java runtimes successfully fetched
```

**Verification Points**:
- Both Java 17 and 21 downloads complete successfully
- SHA256 checksums match expected values
- Both `java.exe` files exist at expected paths
- No errors or warnings during extraction

### Step 2: Verify Runtime Paths
```bash
dir electron\vendor\java\win32-x64\jre17\runtime\bin\java.exe
dir electron\vendor\java\win32-x64\jre21\runtime\bin\java.exe
```

**Expected**: Both files exist and are executable.

### Step 3: Build Electron Code
```bash
npm run build:electron
```

**Expected**: TypeScript compilation succeeds with no errors.

### Step 4: Package Application
```bash
npm run package:win
```

**Expected Output**:
- Build completes successfully
- Output directory: `release/win-unpacked/`
- Both runtimes present in packaged output:
  - `release/win-unpacked/resources/java/win32-x64/jre17/runtime/bin/java.exe`
  - `release/win-unpacked/resources/java/win32-x64/jre21/runtime/bin/java.exe`

### Step 5: Verify Packaged Runtimes
```bash
dir release\win-unpacked\resources\java\win32-x64\jre17\runtime\bin\java.exe
dir release\win-unpacked\resources\java\win32-x64\jre21\runtime\bin\java.exe
```

**Expected**: Both files exist in packaged output.

## Clean Machine Validation

### Prerequisites
- Clean Windows machine (or VM) with NO Java installed
- No `MINEANVIL_JAVA_PATH` environment variable set
- No `MINEANVIL_ALLOW_PATH_JAVA` environment variable set
- Packaged MineAnvil build (`release/win-unpacked/`)

### Test Case 1: Launch Modern Minecraft (Java 21)

**Steps**:
1. Launch MineAnvil from packaged build
2. Sign in with Microsoft account
3. Verify Minecraft ownership
4. Launch Minecraft 1.21.11 (or any version >= 1.20.5)
5. Observe console logs

**Expected Logs**:
```
[javaSelection] Minecraft version: 1.21.11 requires Java 21
[javaSelection] Using bundled Java 21: C:\...\resources\java\win32-x64\jre21\runtime\bin\java.exe
```

**Expected Result**:
- Minecraft launches successfully
- No errors about missing Java
- No errors about unsupported class version
- Java 21 is used (verified in logs)

### Test Case 2: Launch Legacy Minecraft (Java 17)

**Steps**:
1. Launch MineAnvil from packaged build
2. Sign in with Microsoft account (if not already)
3. Launch Minecraft 1.20.4 (or any version < 1.20.5)
4. Observe console logs

**Expected Logs**:
```
[javaSelection] Minecraft version: 1.20.4 requires Java 17
[javaSelection] Using bundled Java 17: C:\...\resources\java\win32-x64\jre17\runtime\bin\java.exe
```

**Expected Result**:
- Minecraft launches successfully
- No errors about missing Java
- Java 17 is used (verified in logs)

### Test Case 3: Version Threshold Boundary

**Steps**:
1. Launch Minecraft 1.20.5 (exact threshold version)
2. Observe console logs

**Expected Logs**:
```
[javaSelection] Minecraft version: 1.20.5 requires Java 21
[javaSelection] Using bundled Java 21: C:\...\resources\java\win32-x64\jre21\runtime\bin\java.exe
```

**Expected Result**:
- Java 21 is selected (threshold is inclusive)
- Minecraft launches successfully

### Test Case 4: Missing Runtime Error (Simulated)

**Setup**:
1. Rename `resources/java/win32-x64/jre21/` to simulate missing runtime
2. Attempt to launch Minecraft 1.21.11

**Expected Error**:
```
No Java 21 runtime available for Minecraft 1.21.11. Reinstall MineAnvil or set MINEANVIL_JAVA_PATH to a Java 21 installation.
```

**Expected Result**:
- Clear, actionable error message
- Error specifies required Java version (21)
- Parent-facing message suggests reinstalling
- Developer hint mentions environment variable (logged only)

### Validation Checklist

- [ ] Packaged build runs on clean Windows machine with no Java installed
- [ ] Minecraft 1.21.x launches successfully using Java 21
- [ ] Minecraft 1.20.4 launches successfully using Java 17
- [ ] Minecraft 1.20.5 launches successfully using Java 21 (boundary test)
- [ ] Console logs show correct Java version selected per Minecraft version
- [ ] No environment variable configuration required
- [ ] No "Java required" errors displayed to parents
- [ ] Bundled runtime paths are deterministic (no globbing)
- [ ] Error messages are clear and specify required Java version
- [ ] Both runtimes exist in packaged output

## Error Messages

### Missing Bundled Runtime
**Context**: Packaged build missing required Java runtime

**Parent-Facing Message**:
```
No Java [17|21] runtime available for Minecraft [version].
Reinstall MineAnvil or set MINEANVIL_JAVA_PATH to a Java [17|21] installation.
```

**Guidance**:
- Clear and actionable
- Specifies required Java major version
- Suggests reinstalling (primary solution)
- Mentions environment variable (dev-only fallback, not emphasized)

### Wrong Java Version
**Context**: MINEANVIL_JAVA_PATH points to wrong Java version

**Console Log**:
```
[javaSelection] MINEANVIL_JAVA_PATH points to Java with wrong version (expected 21): openjdk version "17.0.13"
```

**Guidance**:
- Logged only (not displayed to parents)
- Clearly states expected vs actual version
- Resolution falls back to bundled runtime or PATH

## Acceptance Criteria

SP1.7 is complete ONLY when:
- [x] Both Java 17 and 21 JREs are bundled in packaged builds
- [x] `getRequiredJavaMajorForMinecraftVersion()` implements version threshold logic
- [x] `resolveJavaForMinecraftVersion()` implements resolution order
- [x] Launch pipeline uses version-aware resolution
- [x] Packaging configuration includes both runtimes in extraResources
- [x] Build script fetches and verifies both runtimes
- [x] SHA256 checksums are verified for both downloads
- [x] Directory structure is normalized and deterministic
- [x] Error messages specify required Java major version
- [ ] Clean machine validation passes for both Minecraft versions
- [ ] Logs show correct Java selection per Minecraft version

## Evidence

### Implementation Files
- `electron/src/main/runtime/javaSelection.ts` (NEW)
- `scripts/fetch-java-runtime.ts` (UPDATED)
- `electron/src/main/minecraft/launch.ts` (UPDATED)
- `package.json` (UPDATED)

### Implementation Commit
Commit: `663eaa99ff2cc2bc610c081cdd7eb6a3a76f8b97`
Message: `feat(runtime): implement SP1.7 multi-runtime support (Java 17 + 21)`

### Validation Evidence
- [ ] Clean machine test report (pending)
- [ ] Launch logs showing Java 21 selection for Minecraft 1.21.x
- [ ] Launch logs showing Java 17 selection for Minecraft 1.20.4
- [ ] Packaged output directory listing showing both runtimes

## Related Stop Points

- **SP1.6**: Bundled Java Runtime (Portable Builds) - Single Java 17 runtime
- **SP1.7**: Multi Java Runtime (17 + 21) - Dual runtime with version-aware selection

SP1.7 extends SP1.6 by adding Java 21 support without changing SP1.6's definition or scope.
